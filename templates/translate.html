{% extends "base.html" %}

{% block title %}Translate to Kikuyu{% endblock %}

{% block extra_head %}
<style>
/* Modern Mobile-First Translation Interface */
.translation-card {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.prompt-card {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    border-radius: 12px;
    margin-bottom: 16px;
}

.translation-input {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    transition: all 0.2s ease;
    font-size: 16px; /* Prevents zoom on iOS */
}

.translation-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.btn-modern {
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
}

.btn-primary {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 8px -1px rgba(16, 185, 129, 0.4);
}

.btn-secondary {
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
}

.btn-secondary:hover {
    background: #e5e7eb;
    transform: translateY(-1px);
}

.progress-ring {
    width: 60px;
    height: 60px;
}

.progress-ring circle {
    stroke-width: 4;
    fill: transparent;
    stroke-dasharray: 157; /* 2 * PI * r where r = 25 */
    stroke-dashoffset: 157;
    transition: stroke-dashoffset 0.3s ease;
}

.guidelines-toggle {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    color: #92400e;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.guidelines-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.guidelines-content.expanded {
    max-height: 300px;
}

.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    padding: 16px 20px;
    z-index: 1000;
    transform: translateX(400px);
    transition: transform 0.3s ease;
}

.toast.show {
    transform: translateX(0);
}

.character-count {
    font-size: 12px;
    color: #6b7280;
    transition: color 0.2s ease;
}

.floating-actions {
    position: static;
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 24px;
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-white">
    <!-- Header with Guidelines -->
    <div class="bg-white border-b border-gray-100">
        <div class="max-w-lg mx-auto px-4 py-3 text-center">
            <button class="guidelines-toggle" onclick="toggleGuidelines()">
                Guidelines
            </button>
        </div>
    </div>

    <!-- Guidelines (Collapsible) -->
    <div id="guidelines" class="guidelines-content bg-amber-50 border-b border-amber-200">
        <div class="max-w-lg mx-auto px-4 py-4">
            <div class="text-sm text-amber-800 space-y-2">
                <p><strong>Quality Matters:</strong> Provide accurate translations to preserve Kikuyu heritage.</p>
                <ul class="space-y-1 ml-4">
                    <li>• Translate meaning, not word-for-word</li>
                    <li>• Use proper Kikuyu grammar</li>
                    <li>• Skip if unsure rather than guess</li>
                </ul>
                <p class="text-xs text-amber-700 pt-2"><strong>Privacy:</strong> Only translations are stored. No personal data collected.</p>
            </div>
        </div>
    </div>

    <!-- Main Translation Interface -->
    <div class="max-w-lg mx-auto px-4 py-6">
        <!-- Important Tip -->
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
            <p class="text-sm text-blue-800"><strong>Important:</strong> Think about what the English phrase means, then express that in Kikuyu</p>
        </div>


        <!-- English Prompt -->
        <div class="prompt-card p-4 mb-4">
            <div class="flex items-start space-x-3">
                <div class="w-6 h-6 bg-white bg-opacity-20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span class="text-xs font-bold">EN</span>
                </div>
                <div>
                    <p class="text-sm text-blue-100 mb-1">English</p>
                    <p class="text-lg font-medium leading-relaxed">"{{ prompt.text }}"</p>
                </div>
            </div>
        </div>

        <!-- Translation Form -->
        <form method="POST" id="translationForm" class="translation-card p-4">
            {{ form.hidden_tag() }}
            {{ form.prompt_id() }}

            <div class="flex items-start space-x-3 mb-4">
                <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-3">
                    <span class="text-xs font-bold">KI</span>
                </div>
                <div class="flex-1">
                    <label class="text-sm text-gray-600 mb-2 block">Your Translation</label>
                    {{ form.kikuyu_text(
                        class="translation-input w-full p-3 resize-none",
                        placeholder="Write your translation here...",
                        rows="3",
                        maxlength="1000",
                        id="kikuyuText"
                    ) }}
                    <div class="flex justify-between items-center mt-2">
                        <span class="character-count" id="charCounter">0 / 1000</span>
                        <div class="flex items-center space-x-2 text-xs text-gray-500">
                            <span>Auto-save</span>
                            <span class="w-2 h-2 bg-green-400 rounded-full" id="saveIndicator"></span>
                        </div>
                    </div>
                </div>
            </div>
        </form>

    </div>

    <!-- Action Buttons -->
    <div class="floating-actions">
        <button type="button" class="btn-modern btn-secondary px-4 py-3" id="skipBtn">
            <span class="hidden sm:inline">Skip</span>
            <span class="sm:hidden">Skip</span>
        </button>
        <button type="submit" form="translationForm" class="btn-modern btn-primary px-6 py-3" id="submitBtn">
            <span class="ml-1">Submit</span>
        </button>
    </div>
</div>

<!-- Toast Notification Template -->
<div id="toastTemplate" class="toast" style="display: none;">
    <div class="flex items-center space-x-3">
        <div class="w-8 h-8 rounded-full flex items-center justify-center" id="toastIcon">
            <span class="text-lg">✓</span>
        </div>
        <div>
            <p class="font-medium text-gray-800" id="toastTitle">Success!</p>
            <p class="text-sm text-gray-600" id="toastMessage">Translation submitted successfully</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const textArea = document.getElementById('kikuyuText');
    const charCounter = document.getElementById('charCounter');
    const submitBtn = document.getElementById('submitBtn');
    const saveIndicator = document.getElementById('saveIndicator');

    let saveTimeout;

    // Enhanced character counter with smooth updates
    function updateCharCounter() {
        const length = textArea.value.length;
        charCounter.textContent = `${length} / 1000`;

        // Color transitions
        if (length > 900) {
            charCounter.style.color = '#ef4444';
        } else if (length > 700) {
            charCounter.style.color = '#f59e0b';
        } else {
            charCounter.style.color = '#6b7280';
        }

        // Button state
        submitBtn.disabled = length < 2 || length > 1000;
        submitBtn.style.opacity = submitBtn.disabled ? '0.5' : '1';
    }

    // Auto-save indication
    function showAutoSave() {
        saveIndicator.style.backgroundColor = '#fbbf24';
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            saveIndicator.style.backgroundColor = '#10b981';
        }, 1000);
    }

    // Auto-resize textarea
    function autoResize() {
        textArea.style.height = 'auto';
        textArea.style.height = Math.min(textArea.scrollHeight, 120) + 'px';
    }

    // Event listeners
    textArea.addEventListener('input', function() {
        updateCharCounter();
        autoResize();
        showAutoSave();
    });

    // Form submission with better UX
    document.getElementById('translationForm').addEventListener('submit', function(e) {
        const text = textArea.value.trim();
        if (text.length < 2) {
            e.preventDefault();
            textArea.focus();
            return;
        }
        if (text.length > 1000) {
            e.preventDefault();
            textArea.focus();
            return;
        }

        // Success feedback
        submitBtn.innerHTML = '<span class="ml-1">Saving...</span>';
        submitBtn.disabled = true;

        // Don't prevent - let form submit naturally
    });

    // Skip functionality
    document.getElementById('skipBtn').addEventListener('click', function() {
        this.innerHTML = '<span class="ml-1">Skipping...</span>';
        this.disabled = true;

        // Create skip form
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("main.skip_prompt", prompt_id=prompt.id) }}';

        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrf_token';
        csrfToken.value = '{{ csrf_token() }}';
        form.appendChild(csrfToken);

        document.body.appendChild(form);
        form.submit();
    });

    // Initialize
    updateCharCounter();
    autoResize();
    textArea.focus();
});

// Guidelines toggle
function toggleGuidelines() {
    const guidelines = document.getElementById('guidelines');
    guidelines.classList.toggle('expanded');
}

// Toast notification system
function showToast(icon, title, message, type = 'success') {
    const template = document.getElementById('toastTemplate');
    const toast = template.cloneNode(true);
    toast.id = 'toast-' + Date.now();
    toast.style.display = 'block';

    const iconEl = toast.querySelector('#toastIcon span');
    const titleEl = toast.querySelector('#toastTitle');
    const messageEl = toast.querySelector('#toastMessage');
    const iconContainer = toast.querySelector('#toastIcon');

    iconEl.textContent = icon;
    titleEl.textContent = title;
    messageEl.textContent = message;

    // Style based on type
    if (type === 'error') {
        iconContainer.style.backgroundColor = '#fee2e2';
        iconContainer.style.color = '#dc2626';
    } else {
        iconContainer.style.backgroundColor = '#dcfce7';
        iconContainer.style.color = '#16a34a';
    }

    document.body.appendChild(toast);

    // Show toast
    setTimeout(() => toast.classList.add('show'), 100);

    // Hide toast
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Only show success message after submission
// Error handling is done via form validation, no popups needed
</script>
{% endblock %}